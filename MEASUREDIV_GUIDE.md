# Руководство по использованию measureDiv (Коэффициент фасовки)

## Обзор

Функциональность `measureDiv` была добавлена для корректной генерации QR-кодов GS1 для товаров, продающихся порциями (например, по 0.25 шт, 0.5 шт и т.д.).

## Проблема

Ранее, при генерации товара с количеством **0.5 шт**, генератор создавал код с `AI 37 = 5` и `AI 97 = 1`, что касса интерпретировала как **5 шт** вместо **0.5 шт**.

## Решение

Теперь можно указать **коэффициент фасовки (measureDiv)**, который определяет размер одной порции товара. Генератор автоматически пересчитывает желаемое количество в количество порций и генерирует код **БЕЗ** `AI 97`.

## Как это работает

### Формула

```
Количество порций = Желаемое количество / Коэффициент фасовки
```

### Пример

**Исходные данные:**
- GoodsId: 880
- Коэффициент в кассе: 0.25
- Желаемое количество: 0.5 шт

**Расчёт:**
```
Порций = 0.5 / 0.25 = 2
```

**Сгенерированный код:**
```
99MPUC<GS>240880<GS>3700000002<GS>
```

**Результат на кассе:**
```
2 порции × 0.25 = 0.5 шт ✅
```

## Интерфейс пользователя

В форме генерации GS1 кодов добавлен новый элемент **"Коэффициент фасовки (measureDiv)"** с предустановленными значениями:

- **Обычный товар (1.0)** - стандартные штучные товары без коэффициента
- **Половинки (0.5)** - товар продаётся по 0.5 шт
- **Четвертинки (0.25)** - товар продаётся по 0.25 шт
- **По 200г (0.2)** - товар продаётся порциями по 0.2 шт
- **По 100г (0.1)** - товар продаётся порциями по 0.1 шт
- **Другое...** - возможность ввести своё значение

## Примеры использования

### Пример 1: Товар 880 с коэф. 0.25, количество 0.5 шт

**Настройки в UI:**
- GoodsId: 880
- Тип товара: Штучный
- Количество: 0.5 (random или fixed)
- Коэффициент фасовки: 0.25
- Скидка: 0%

**Сгенерированный код:**
```
99MPUC<GS>240880<GS>3700000002<GS>
```

**Пояснение:**
- `240880` - GoodsId
- `3700000002` - AI 37 с количеством **2 порции**
- Нет AI 97 (дробной части)
- Касса: 2 × 0.25 = **0.5 шт** ✅

### Пример 2: Товар 880 с коэф. 0.25, количество 0.5 шт со скидкой 50%

**Настройки в UI:**
- GoodsId: 880
- Тип товара: Штучный
- Количество: 0.5
- Коэффициент фасовки: 0.25
- Скидка: 50%

**Сгенерированный код:**
```
99MPUC<GS>240880<GS>3700000002<GS>9850<GS>2175FKWUIA<GS>
```

**Пояснение:**
- `240880` - GoodsId
- `3700000002` - 2 порции
- `9850` - AI 98, скидка 50%
- `2175FKWUIA` - AI 21, уникальный идентификатор
- Нет AI 97
- Касса: 2 × 0.25 = **0.5 шт** со скидкой 50% ✅

### Пример 3: Товар 880 с коэф. 0.25, количество 1.0 шт

**Настройки в UI:**
- GoodsId: 880
- Количество: 1.0
- Коэффициент фасовки: 0.25

**Сгенерированный код:**
```
99MPUC<GS>240880<GS>3700000004<GS>
```

**Пояснение:**
- `3700000004` - 4 порции
- Касса: 4 × 0.25 = **1.0 шт** ✅

### Пример 4: Обычный товар БЕЗ коэффициента (дробное количество)

**Настройки в UI:**
- GoodsId: 123
- Количество: 12.45
- Коэффициент фасовки: 1.0 (Обычный товар)
- Скидка: 10%

**Сгенерированный код:**
```
99MPUC<GS>240123<GS>3700001245<GS>9810<GS>21ABC12345<GS>972<GS>
```

**Пояснение:**
- `3700001245` - Quantity_raw = 1245
- `9810` - скидка 10%
- `21ABC12345` - UniqueID
- `972` - AI 97, DecimalPosition = 2
- Касса: 1245 / 10² = **12.45 шт** ✅

## Отображение в интерфейсе

### В списке товаров

Товары с коэффициентом фасовки отображаются как:
```
2 порц. (≈0.50 шт)
```

### В карусели

При ротации отображается:
```
GoodsId: 880 | Кол-во: 2 порц. (≈0.50 шт) | Скидка: 50%
```

## Технические детали

### Алгоритм генерации (для разработчиков)

1. **Проверка measureDiv:**
   - Если `measureDiv === 1` → обычный товар с AI 97
   - Если `measureDiv !== 1` → товар с порциями БЕЗ AI 97

2. **Расчёт количества порций:**
   ```javascript
   var portions = Math.round(desiredQuantity / measureDiv);
   ```

3. **Генерация AI 37:**
   ```javascript
   code += AI_QUANTITY + padZeros(portions, 8) + GS;
   ```

4. **AI 97 НЕ добавляется** для товаров с measureDiv

### Структура данных item

```javascript
{
    id: '...',
    code: '99MPUC<GS>240880<GS>3700000002<GS>',
    goodsId: '880',
    type: 'piece',
    quantity: 2,              // Количество порций
    measureDiv: 0.25,         // Коэффициент фасовки
    actualQuantity: 0.5,      // Фактическое количество (порции × measureDiv)
    desiredQuantity: 0.5,     // Желаемое количество (исходное)
    discount: 0,
    uniqueId: null,
    decimalPosition: 0,       // Всегда 0 для товаров с measureDiv
    active: true
}
```

## Тестирование

Добавлены тесты в `test-gs1.html`:

- **Тест 7:** Товар 880, measureDiv 0.25, 0.5 шт (2 порции)
- **Тест 8:** Товар 880, measureDiv 0.25, 0.5 шт со скидкой 50%
- **Тест 9:** Товар 880, measureDiv 0.25, 1.0 шт (4 порции)
- **Тест 10:** Товар 123, measureDiv 0.5, 1.5 шт (3 порции) со скидкой

## Часто задаваемые вопросы

### 1. Что такое measureDiv?

Это коэффициент фасовки, который определяет, каким образом товар упакован/продаётся. Например, если товар продаётся порциями по 0.25 шт (четвертинками), то `measureDiv = 0.25`.

### 2. Когда использовать measureDiv?

Используйте measureDiv, когда в вашей кассе товар настроен с коэффициентом, отличным от 1.0.

### 3. Как узнать, какой коэффициент у товара в кассе?

Обычно это указано в настройках товара в кассе. Проверьте раздел "Единица измерения" или "Коэффициент".

### 4. Можно ли использовать дробные коэффициенты?

Да, можно использовать любые положительные числа: 0.1, 0.25, 0.5, 0.75, 2.5 и т.д.

### 5. Что если я укажу неправильный коэффициент?

Касса покажет неправильное количество товара. Например, если в кассе коэф. 0.25, а вы укажете 1.0, то касса покажет в 4 раза больше товара.

### 6. Работает ли measureDiv с весовыми товарами?

Нет, measureDiv применяется только к штучным товарам. Весовые товары всегда используют AI 3103 с весом в граммах.

## Обновлённые файлы

1. **index.html** - добавлен UI для выбора measureDiv
2. **js/controllers/gs1.controller.js** - чтение measureDiv и пересчёт в порции
3. **js/generators/generators.js** - логика генерации с/без AI 97
4. **js/ui/ui.js** - отображение количества с учётом measureDiv
5. **js/main.js** - обработка событий переключения пресета/кастомного поля
6. **test-gs1.html** - добавлены тесты с measureDiv

## Поддержка

При возникновении проблем проверьте:
1. Правильно ли указан коэффициент в кассе
2. Соответствует ли коэффициент в генераторе коэффициенту в кассе
3. Прошли ли все тесты в test-gs1.html
